services:
  # ─────────────────────────────────────────────
  # Infrastructure Services
  # ─────────────────────────────────────────────

  postgres:
    image: postgres:16
    container_name: ecommerce-postgres
    ports:
      - "15432:5432"
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-ecommerce}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-ecommerce_secret}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./infra/docker/postgres/create-multiple-dbs.sh:/docker-entrypoint-initdb.d/create-multiple-dbs.sh
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-ecommerce}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ecommerce-network

  redis:
    image: redis:7-alpine
    container_name: ecommerce-redis
    ports:
      - "16379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ecommerce-network

  nats:
    image: nats:2.10-alpine
    container_name: ecommerce-nats
    ports:
      - "14222:4222"
      - "18222:8222"
    command: "--jetstream --store_dir /data"
    volumes:
      - nats_data:/data
    networks:
      - ecommerce-network

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.12.0
    container_name: ecommerce-elasticsearch
    ports:
      - "19200:9200"
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
    volumes:
      - es_data:/usr/share/elasticsearch/data
    networks:
      - ecommerce-network

  minio:
    image: minio/minio:latest
    container_name: ecommerce-minio
    ports:
      - "19000:9000"
      - "19001:9001"
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    volumes:
      - minio_data:/data
    networks:
      - ecommerce-network

  # ─────────────────────────────────────────────
  # API Gateway
  # ─────────────────────────────────────────────

  kong:
    image: kong/kong-gateway:3.6
    container_name: ecommerce-kong
    ports:
      - "18000:8000"
      - "18001:8001"
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /etc/kong/kong.yml
      KONG_PROXY_LISTEN: "0.0.0.0:8000"
      KONG_ADMIN_LISTEN: "0.0.0.0:8001"
      KONG_LOG_LEVEL: info
    volumes:
      - ./kong/kong.yml:/etc/kong/kong.yml:ro
    depends_on:
      auth:
        condition: service_started
      user:
        condition: service_started
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - ecommerce-network

  # ─────────────────────────────────────────────
  # Application Services
  # ─────────────────────────────────────────────

  auth:
    build:
      context: .
      dockerfile: services/auth/Dockerfile
    container_name: ecommerce-auth
    ports:
      - "8090:8090"
      - "19090:9090"
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: "5432"
      POSTGRES_USER: ecommerce
      POSTGRES_PASSWORD: ecommerce_secret
      DB_NAME: ecommerce_auth
      REDIS_URL: redis://redis:6379
      NATS_URL: nats://nats:4222
      JWT_SECRET: ${JWT_SECRET:-change-this-to-a-256-bit-secret-in-production}
      HTTP_PORT: "8090"
      GRPC_PORT: "9090"
      LOG_LEVEL: debug
      OTEL_EXPORTER_OTLP_ENDPOINT: otel-collector:4317
      ENVIRONMENT: development
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      nats:
        condition: service_started
    networks:
      - ecommerce-network

  user:
    build:
      context: .
      dockerfile: services/user/Dockerfile
    container_name: ecommerce-user
    ports:
      - "8091:8091"
      - "19091:9091"
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: "5432"
      POSTGRES_USER: ecommerce
      POSTGRES_PASSWORD: ecommerce_secret
      DB_NAME: ecommerce_users
      NATS_URL: nats://nats:4222
      HTTP_PORT: "8091"
      GRPC_PORT: "9091"
      LOG_LEVEL: debug
      AUTH_GRPC_ADDR: auth:9090
      OTEL_EXPORTER_OTLP_ENDPOINT: otel-collector:4317
      ENVIRONMENT: development
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      nats:
        condition: service_started
      auth:
        condition: service_started
    networks:
      - ecommerce-network

  # ─────────────────────────────────────────────
  # Phase 2: Core Commerce Services
  # ─────────────────────────────────────────────

  product:
    build:
      context: .
      dockerfile: services/product/Dockerfile
    container_name: ecommerce-product
    ports:
      - "8081:8081"
      - "19081:9081"
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: "5432"
      POSTGRES_USER: ecommerce
      POSTGRES_PASSWORD: ecommerce_secret
      DB_NAME: ecommerce_products
      NATS_URL: nats://nats:4222
      HTTP_PORT: "8081"
      GRPC_PORT: "9081"
      LOG_LEVEL: debug
      OTEL_EXPORTER_OTLP_ENDPOINT: otel-collector:4317
      ENVIRONMENT: development
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_started
    networks:
      - ecommerce-network

  cart:
    build:
      context: .
      dockerfile: services/cart/Dockerfile
    container_name: ecommerce-cart
    ports:
      - "8082:8082"
      - "19082:9082"
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: "5432"
      POSTGRES_USER: ecommerce
      POSTGRES_PASSWORD: ecommerce_secret
      DB_NAME: ecommerce_cart
      REDIS_URL: redis:6379
      NATS_URL: nats://nats:4222
      HTTP_PORT: "8082"
      GRPC_PORT: "9082"
      LOG_LEVEL: debug
      OTEL_EXPORTER_OTLP_ENDPOINT: otel-collector:4317
      ENVIRONMENT: development
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      nats:
        condition: service_started
    networks:
      - ecommerce-network

  order:
    build:
      context: .
      dockerfile: services/order/Dockerfile
    container_name: ecommerce-order
    ports:
      - "8083:8083"
      - "19083:9083"
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: "5432"
      POSTGRES_USER: ecommerce
      POSTGRES_PASSWORD: ecommerce_secret
      DB_NAME: ecommerce_orders
      NATS_URL: nats://nats:4222
      HTTP_PORT: "8083"
      GRPC_PORT: "9083"
      LOG_LEVEL: debug
      OTEL_EXPORTER_OTLP_ENDPOINT: otel-collector:4317
      ENVIRONMENT: development
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_started
    networks:
      - ecommerce-network

  payment:
    build:
      context: .
      dockerfile: services/payment/Dockerfile
    container_name: ecommerce-payment
    ports:
      - "8084:8084"
      - "19084:9084"
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: "5432"
      POSTGRES_USER: ecommerce
      POSTGRES_PASSWORD: ecommerce_secret
      DB_NAME: ecommerce_payments
      NATS_URL: nats://nats:4222
      HTTP_PORT: "8084"
      GRPC_PORT: "9084"
      LOG_LEVEL: debug
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-sk_test_mock}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-whsec_mock}
      PLATFORM_COMMISSION_RATE: "0.10"
      OTEL_EXPORTER_OTLP_ENDPOINT: otel-collector:4317
      ENVIRONMENT: development
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_started
    networks:
      - ecommerce-network

  tax:
    build:
      context: .
      dockerfile: services/tax/Dockerfile
    container_name: ecommerce-tax
    ports:
      - "8098:8098"
      - "19098:9098"
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: "5432"
      POSTGRES_USER: ecommerce
      POSTGRES_PASSWORD: ecommerce_secret
      DB_NAME: ecommerce_tax
      HTTP_PORT: "8098"
      GRPC_PORT: "9098"
      LOG_LEVEL: debug
      OTEL_EXPORTER_OTLP_ENDPOINT: otel-collector:4317
      ENVIRONMENT: development
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - ecommerce-network

  # ─────────────────────────────────────────────
  # Phase 3: Shipping & Fulfillment Services
  # ─────────────────────────────────────────────

  shipping:
    build:
      context: .
      dockerfile: services/shipping/Dockerfile
    container_name: ecommerce-shipping
    ports:
      - "8085:8085"
      - "19085:9085"
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: "5432"
      POSTGRES_USER: ecommerce
      POSTGRES_PASSWORD: ecommerce_secret
      DB_NAME: ecommerce_shipping
      NATS_URL: nats://nats:4222
      HTTP_PORT: "8085"
      GRPC_PORT: "9085"
      LOG_LEVEL: debug
      OTEL_EXPORTER_OTLP_ENDPOINT: otel-collector:4317
      ENVIRONMENT: development
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_started
    networks:
      - ecommerce-network

  return:
    build:
      context: .
      dockerfile: services/return/Dockerfile
    container_name: ecommerce-return
    ports:
      - "8086:8086"
      - "19086:9086"
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: "5432"
      POSTGRES_USER: ecommerce
      POSTGRES_PASSWORD: ecommerce_secret
      DB_NAME: ecommerce_returns
      NATS_URL: nats://nats:4222
      HTTP_PORT: "8086"
      GRPC_PORT: "9086"
      LOG_LEVEL: debug
      OTEL_EXPORTER_OTLP_ENDPOINT: otel-collector:4317
      ENVIRONMENT: development
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_started
    networks:
      - ecommerce-network

  # ─────────────────────────────────────────────
  # Phase 4: Supporting Services
  # ─────────────────────────────────────────────

  search:
    build:
      context: .
      dockerfile: services/search/Dockerfile
    container_name: ecommerce-search
    ports:
      - "8087:8087"
      - "19087:9087"
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: "5432"
      POSTGRES_USER: ecommerce
      POSTGRES_PASSWORD: ecommerce_secret
      DB_NAME: ecommerce_search
      NATS_URL: nats://nats:4222
      ELASTICSEARCH_URL: http://elasticsearch:9200
      HTTP_PORT: "8087"
      GRPC_PORT: "9087"
      LOG_LEVEL: debug
      OTEL_EXPORTER_OTLP_ENDPOINT: otel-collector:4317
      ENVIRONMENT: development
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_started
      elasticsearch:
        condition: service_started
    networks:
      - ecommerce-network

  review:
    build:
      context: .
      dockerfile: services/review/Dockerfile
    container_name: ecommerce-review
    ports:
      - "8088:8088"
      - "19088:9088"
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: "5432"
      POSTGRES_USER: ecommerce
      POSTGRES_PASSWORD: ecommerce_secret
      DB_NAME: ecommerce_reviews
      NATS_URL: nats://nats:4222
      HTTP_PORT: "8088"
      GRPC_PORT: "9088"
      LOG_LEVEL: debug
      OTEL_EXPORTER_OTLP_ENDPOINT: otel-collector:4317
      ENVIRONMENT: development
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_started
    networks:
      - ecommerce-network

  media:
    build:
      context: .
      dockerfile: services/media/Dockerfile
    container_name: ecommerce-media
    ports:
      - "8089:8089"
      - "19089:9089"
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: "5432"
      POSTGRES_USER: ecommerce
      POSTGRES_PASSWORD: ecommerce_secret
      DB_NAME: ecommerce_media
      NATS_URL: nats://nats:4222
      S3_ENDPOINT: minio:9000
      S3_ACCESS_KEY: ${MINIO_ROOT_USER:-minioadmin}
      S3_SECRET_KEY: ${MINIO_ROOT_PASSWORD:-minioadmin}
      S3_BUCKET: ecommerce-media
      S3_REGION: us-east-1
      HTTP_PORT: "8089"
      GRPC_PORT: "9089"
      LOG_LEVEL: debug
      OTEL_EXPORTER_OTLP_ENDPOINT: otel-collector:4317
      ENVIRONMENT: development
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_started
      minio:
        condition: service_started
    networks:
      - ecommerce-network

  notification:
    build:
      context: .
      dockerfile: services/notification/Dockerfile
    container_name: ecommerce-notification
    ports:
      - "8092:8092"
      - "19092:9092"
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: "5432"
      POSTGRES_USER: ecommerce
      POSTGRES_PASSWORD: ecommerce_secret
      DB_NAME: ecommerce_notifications
      NATS_URL: nats://nats:4222
      SMTP_HOST: mailhog
      SMTP_PORT: "1025"
      HTTP_PORT: "8092"
      GRPC_PORT: "9092"
      LOG_LEVEL: debug
      OTEL_EXPORTER_OTLP_ENDPOINT: otel-collector:4317
      ENVIRONMENT: development
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_started
    networks:
      - ecommerce-network

  cms:
    build:
      context: .
      dockerfile: services/cms/Dockerfile
    container_name: ecommerce-cms
    ports:
      - "8099:8099"
      - "19099:9099"
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: "5432"
      POSTGRES_USER: ecommerce
      POSTGRES_PASSWORD: ecommerce_secret
      DB_NAME: ecommerce_cms
      NATS_URL: nats://nats:4222
      HTTP_PORT: "8099"
      GRPC_PORT: "9099"
      LOG_LEVEL: debug
      OTEL_EXPORTER_OTLP_ENDPOINT: otel-collector:4317
      ENVIRONMENT: development
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_started
    networks:
      - ecommerce-network

  # ─────────────────────────────────────────────
  # Phase 5: Promotions & Engagement Services
  # ─────────────────────────────────────────────

  promotion:
    build:
      context: .
      dockerfile: services/promotion/Dockerfile
    container_name: ecommerce-promotion
    ports:
      - "8093:8093"
      - "19093:9093"
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: "5432"
      POSTGRES_USER: ecommerce
      POSTGRES_PASSWORD: ecommerce_secret
      DB_NAME: ecommerce_promotions
      NATS_URL: nats://nats:4222
      HTTP_PORT: "8093"
      GRPC_PORT: "9093"
      LOG_LEVEL: debug
      OTEL_EXPORTER_OTLP_ENDPOINT: otel-collector:4317
      ENVIRONMENT: development
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_started
    networks:
      - ecommerce-network

  loyalty:
    build:
      context: .
      dockerfile: services/loyalty/Dockerfile
    container_name: ecommerce-loyalty
    ports:
      - "8096:8096"
      - "19096:9096"
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: "5432"
      POSTGRES_USER: ecommerce
      POSTGRES_PASSWORD: ecommerce_secret
      DB_NAME: ecommerce_loyalty
      NATS_URL: nats://nats:4222
      HTTP_PORT: "8096"
      GRPC_PORT: "9096"
      LOG_LEVEL: debug
      OTEL_EXPORTER_OTLP_ENDPOINT: otel-collector:4317
      ENVIRONMENT: development
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_started
    networks:
      - ecommerce-network

  affiliate:
    build:
      context: .
      dockerfile: services/affiliate/Dockerfile
    container_name: ecommerce-affiliate
    ports:
      - "8097:8097"
      - "19097:9097"
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: "5432"
      POSTGRES_USER: ecommerce
      POSTGRES_PASSWORD: ecommerce_secret
      DB_NAME: ecommerce_affiliates
      NATS_URL: nats://nats:4222
      HTTP_PORT: "8097"
      GRPC_PORT: "9097"
      LOG_LEVEL: debug
      OTEL_EXPORTER_OTLP_ENDPOINT: otel-collector:4317
      ENVIRONMENT: development
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_started
    networks:
      - ecommerce-network

  # ─────────────────────────────────────────────
  # Phase 6: Real-Time & AI Services
  # ─────────────────────────────────────────────

  chat:
    build:
      context: .
      dockerfile: services/chat/Dockerfile
    container_name: ecommerce-chat
    ports:
      - "8094:8094"
      - "19094:9094"
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: "5432"
      POSTGRES_USER: ecommerce
      POSTGRES_PASSWORD: ecommerce_secret
      DB_NAME: ecommerce_chat
      NATS_URL: nats://nats:4222
      HTTP_PORT: "8094"
      GRPC_PORT: "9094"
      LOG_LEVEL: debug
      OTEL_EXPORTER_OTLP_ENDPOINT: otel-collector:4317
      ENVIRONMENT: development
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_started
    networks:
      - ecommerce-network

  ai:
    build:
      context: .
      dockerfile: services/ai/Dockerfile
    container_name: ecommerce-ai
    ports:
      - "8095:8095"
      - "19095:9095"
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: "5432"
      POSTGRES_USER: ecommerce
      POSTGRES_PASSWORD: ecommerce_secret
      DB_NAME: ecommerce_ai
      NATS_URL: nats://nats:4222
      HTTP_PORT: "8095"
      GRPC_PORT: "9095"
      LOG_LEVEL: debug
      AI_PYTHON_SERVICE_URL: http://ai-python:8000
      OTEL_EXPORTER_OTLP_ENDPOINT: otel-collector:4317
      ENVIRONMENT: development
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_started
    networks:
      - ecommerce-network

networks:
  ecommerce-network:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
  nats_data:
  es_data:
  minio_data:
