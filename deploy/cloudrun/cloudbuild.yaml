# =============================================================================
# Google Cloud Build configuration
# Builds and deploys all 19 ecommerce microservices to Cloud Run.
#
# Trigger this via:
#   gcloud builds submit --config=deploy/cloudrun/cloudbuild.yaml .
#
# Or set up a Cloud Build trigger on push to main branch.
#
# Required substitutions (set in trigger or command line):
#   _REGION: GCP region (e.g., us-central1)
#   _POSTGRES_HOST: Cloud SQL connection string
#   _REDIS_URL: Memorystore Redis URL
#   _NATS_URL: NATS server URL
# =============================================================================

substitutions:
  _REGION: us-central1
  _POSTGRES_HOST: "/cloudsql/${PROJECT_ID}:${_REGION}:ecommerce-db"
  _REDIS_URL: "redis://10.0.0.3:6379"
  _NATS_URL: "nats://nats:4222"
  _ELASTICSEARCH_URL: "http://elasticsearch:9200"

options:
  machineType: E2_HIGHCPU_8
  logging: CLOUD_LOGGING_ONLY
  dynamic_substitutions: true

steps:
  # =========================================================================
  # Step 1: Build all Docker images in parallel
  # =========================================================================
  - id: build-auth
    name: gcr.io/cloud-builders/docker
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/auth:$SHORT_SHA', '-t', 'gcr.io/$PROJECT_ID/auth:latest', '-f', 'services/auth/Dockerfile', '.']
    waitFor: ['-']

  - id: build-user
    name: gcr.io/cloud-builders/docker
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/user:$SHORT_SHA', '-t', 'gcr.io/$PROJECT_ID/user:latest', '-f', 'services/user/Dockerfile', '.']
    waitFor: ['-']

  - id: build-product
    name: gcr.io/cloud-builders/docker
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/product:$SHORT_SHA', '-t', 'gcr.io/$PROJECT_ID/product:latest', '-f', 'services/product/Dockerfile', '.']
    waitFor: ['-']

  - id: build-cart
    name: gcr.io/cloud-builders/docker
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/cart:$SHORT_SHA', '-t', 'gcr.io/$PROJECT_ID/cart:latest', '-f', 'services/cart/Dockerfile', '.']
    waitFor: ['-']

  - id: build-order
    name: gcr.io/cloud-builders/docker
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/order:$SHORT_SHA', '-t', 'gcr.io/$PROJECT_ID/order:latest', '-f', 'services/order/Dockerfile', '.']
    waitFor: ['-']

  - id: build-payment
    name: gcr.io/cloud-builders/docker
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/payment:$SHORT_SHA', '-t', 'gcr.io/$PROJECT_ID/payment:latest', '-f', 'services/payment/Dockerfile', '.']
    waitFor: ['-']

  - id: build-tax
    name: gcr.io/cloud-builders/docker
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/tax:$SHORT_SHA', '-t', 'gcr.io/$PROJECT_ID/tax:latest', '-f', 'services/tax/Dockerfile', '.']
    waitFor: ['-']

  - id: build-shipping
    name: gcr.io/cloud-builders/docker
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/shipping:$SHORT_SHA', '-t', 'gcr.io/$PROJECT_ID/shipping:latest', '-f', 'services/shipping/Dockerfile', '.']
    waitFor: ['-']

  - id: build-return
    name: gcr.io/cloud-builders/docker
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/return:$SHORT_SHA', '-t', 'gcr.io/$PROJECT_ID/return:latest', '-f', 'services/return/Dockerfile', '.']
    waitFor: ['-']

  - id: build-search
    name: gcr.io/cloud-builders/docker
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/search:$SHORT_SHA', '-t', 'gcr.io/$PROJECT_ID/search:latest', '-f', 'services/search/Dockerfile', '.']
    waitFor: ['-']

  - id: build-review
    name: gcr.io/cloud-builders/docker
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/review:$SHORT_SHA', '-t', 'gcr.io/$PROJECT_ID/review:latest', '-f', 'services/review/Dockerfile', '.']
    waitFor: ['-']

  - id: build-media
    name: gcr.io/cloud-builders/docker
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/media:$SHORT_SHA', '-t', 'gcr.io/$PROJECT_ID/media:latest', '-f', 'services/media/Dockerfile', '.']
    waitFor: ['-']

  - id: build-notification
    name: gcr.io/cloud-builders/docker
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/notification:$SHORT_SHA', '-t', 'gcr.io/$PROJECT_ID/notification:latest', '-f', 'services/notification/Dockerfile', '.']
    waitFor: ['-']

  - id: build-cms
    name: gcr.io/cloud-builders/docker
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/cms:$SHORT_SHA', '-t', 'gcr.io/$PROJECT_ID/cms:latest', '-f', 'services/cms/Dockerfile', '.']
    waitFor: ['-']

  - id: build-promotion
    name: gcr.io/cloud-builders/docker
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/promotion:$SHORT_SHA', '-t', 'gcr.io/$PROJECT_ID/promotion:latest', '-f', 'services/promotion/Dockerfile', '.']
    waitFor: ['-']

  - id: build-loyalty
    name: gcr.io/cloud-builders/docker
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/loyalty:$SHORT_SHA', '-t', 'gcr.io/$PROJECT_ID/loyalty:latest', '-f', 'services/loyalty/Dockerfile', '.']
    waitFor: ['-']

  - id: build-affiliate
    name: gcr.io/cloud-builders/docker
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/affiliate:$SHORT_SHA', '-t', 'gcr.io/$PROJECT_ID/affiliate:latest', '-f', 'services/affiliate/Dockerfile', '.']
    waitFor: ['-']

  - id: build-chat
    name: gcr.io/cloud-builders/docker
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/chat:$SHORT_SHA', '-t', 'gcr.io/$PROJECT_ID/chat:latest', '-f', 'services/chat/Dockerfile', '.']
    waitFor: ['-']

  - id: build-ai
    name: gcr.io/cloud-builders/docker
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/ai:$SHORT_SHA', '-t', 'gcr.io/$PROJECT_ID/ai:latest', '-f', 'services/ai/Dockerfile', '.']
    waitFor: ['-']

  # =========================================================================
  # Step 2: Deploy all services to Cloud Run (after all builds complete)
  # =========================================================================
  - id: deploy-auth
    name: gcr.io/cloud-builders/gcloud
    args:
      - run
      - deploy
      - auth-service
      - --image=gcr.io/$PROJECT_ID/auth:$SHORT_SHA
      - --platform=managed
      - --region=$_REGION
      - --port=8090
      - --memory=512Mi
      - --cpu=1
      - --min-instances=0
      - --max-instances=10
      - --allow-unauthenticated
      - --set-env-vars=POSTGRES_HOST=$_POSTGRES_HOST,POSTGRES_PORT=5432,POSTGRES_USER=ecommerce,REDIS_URL=$_REDIS_URL,NATS_URL=$_NATS_URL,HTTP_PORT=8090,GRPC_PORT=9090,DB_NAME=ecommerce_auth,LOG_LEVEL=info
    waitFor: ['build-auth']

  - id: deploy-user
    name: gcr.io/cloud-builders/gcloud
    args:
      - run
      - deploy
      - user-service
      - --image=gcr.io/$PROJECT_ID/user:$SHORT_SHA
      - --platform=managed
      - --region=$_REGION
      - --port=8091
      - --memory=512Mi
      - --cpu=1
      - --min-instances=0
      - --max-instances=10
      - --allow-unauthenticated
      - --set-env-vars=POSTGRES_HOST=$_POSTGRES_HOST,POSTGRES_PORT=5432,POSTGRES_USER=ecommerce,REDIS_URL=$_REDIS_URL,NATS_URL=$_NATS_URL,HTTP_PORT=8091,GRPC_PORT=9091,DB_NAME=ecommerce_users,LOG_LEVEL=info
    waitFor: ['build-user']

  - id: deploy-product
    name: gcr.io/cloud-builders/gcloud
    args:
      - run
      - deploy
      - product-service
      - --image=gcr.io/$PROJECT_ID/product:$SHORT_SHA
      - --platform=managed
      - --region=$_REGION
      - --port=8081
      - --memory=512Mi
      - --cpu=1
      - --min-instances=0
      - --max-instances=10
      - --allow-unauthenticated
      - --set-env-vars=POSTGRES_HOST=$_POSTGRES_HOST,POSTGRES_PORT=5432,POSTGRES_USER=ecommerce,NATS_URL=$_NATS_URL,HTTP_PORT=8081,GRPC_PORT=9081,DB_NAME=ecommerce_products,LOG_LEVEL=info
    waitFor: ['build-product']

  - id: deploy-cart
    name: gcr.io/cloud-builders/gcloud
    args:
      - run
      - deploy
      - cart-service
      - --image=gcr.io/$PROJECT_ID/cart:$SHORT_SHA
      - --platform=managed
      - --region=$_REGION
      - --port=8082
      - --memory=512Mi
      - --cpu=1
      - --min-instances=0
      - --max-instances=10
      - --no-allow-unauthenticated
      - --set-env-vars=POSTGRES_HOST=$_POSTGRES_HOST,POSTGRES_PORT=5432,POSTGRES_USER=ecommerce,REDIS_URL=$_REDIS_URL,NATS_URL=$_NATS_URL,HTTP_PORT=8082,GRPC_PORT=9082,DB_NAME=ecommerce_cart,LOG_LEVEL=info
    waitFor: ['build-cart']

  - id: deploy-order
    name: gcr.io/cloud-builders/gcloud
    args:
      - run
      - deploy
      - order-service
      - --image=gcr.io/$PROJECT_ID/order:$SHORT_SHA
      - --platform=managed
      - --region=$_REGION
      - --port=8083
      - --memory=512Mi
      - --cpu=1
      - --min-instances=0
      - --max-instances=10
      - --no-allow-unauthenticated
      - --set-env-vars=POSTGRES_HOST=$_POSTGRES_HOST,POSTGRES_PORT=5432,POSTGRES_USER=ecommerce,NATS_URL=$_NATS_URL,HTTP_PORT=8083,GRPC_PORT=9083,DB_NAME=ecommerce_orders,LOG_LEVEL=info
    waitFor: ['build-order']

  - id: deploy-payment
    name: gcr.io/cloud-builders/gcloud
    args:
      - run
      - deploy
      - payment-service
      - --image=gcr.io/$PROJECT_ID/payment:$SHORT_SHA
      - --platform=managed
      - --region=$_REGION
      - --port=8084
      - --memory=512Mi
      - --cpu=1
      - --min-instances=0
      - --max-instances=10
      - --no-allow-unauthenticated
      - --set-env-vars=POSTGRES_HOST=$_POSTGRES_HOST,POSTGRES_PORT=5432,POSTGRES_USER=ecommerce,NATS_URL=$_NATS_URL,HTTP_PORT=8084,GRPC_PORT=9084,DB_NAME=ecommerce_payments,PLATFORM_COMMISSION_RATE=0.10,LOG_LEVEL=info
    waitFor: ['build-payment']

  - id: deploy-tax
    name: gcr.io/cloud-builders/gcloud
    args:
      - run
      - deploy
      - tax-service
      - --image=gcr.io/$PROJECT_ID/tax:$SHORT_SHA
      - --platform=managed
      - --region=$_REGION
      - --port=8098
      - --memory=512Mi
      - --cpu=1
      - --min-instances=0
      - --max-instances=10
      - --no-allow-unauthenticated
      - --set-env-vars=POSTGRES_HOST=$_POSTGRES_HOST,POSTGRES_PORT=5432,POSTGRES_USER=ecommerce,HTTP_PORT=8098,GRPC_PORT=9098,DB_NAME=ecommerce_tax,LOG_LEVEL=info
    waitFor: ['build-tax']

  - id: deploy-shipping
    name: gcr.io/cloud-builders/gcloud
    args:
      - run
      - deploy
      - shipping-service
      - --image=gcr.io/$PROJECT_ID/shipping:$SHORT_SHA
      - --platform=managed
      - --region=$_REGION
      - --port=8085
      - --memory=512Mi
      - --cpu=1
      - --min-instances=0
      - --max-instances=10
      - --no-allow-unauthenticated
      - --set-env-vars=POSTGRES_HOST=$_POSTGRES_HOST,POSTGRES_PORT=5432,POSTGRES_USER=ecommerce,NATS_URL=$_NATS_URL,HTTP_PORT=8085,GRPC_PORT=9085,DB_NAME=ecommerce_shipping,LOG_LEVEL=info
    waitFor: ['build-shipping']

  - id: deploy-return
    name: gcr.io/cloud-builders/gcloud
    args:
      - run
      - deploy
      - return-service
      - --image=gcr.io/$PROJECT_ID/return:$SHORT_SHA
      - --platform=managed
      - --region=$_REGION
      - --port=8086
      - --memory=512Mi
      - --cpu=1
      - --min-instances=0
      - --max-instances=10
      - --no-allow-unauthenticated
      - --set-env-vars=POSTGRES_HOST=$_POSTGRES_HOST,POSTGRES_PORT=5432,POSTGRES_USER=ecommerce,NATS_URL=$_NATS_URL,HTTP_PORT=8086,GRPC_PORT=9086,DB_NAME=ecommerce_returns,LOG_LEVEL=info
    waitFor: ['build-return']

  - id: deploy-search
    name: gcr.io/cloud-builders/gcloud
    args:
      - run
      - deploy
      - search-service
      - --image=gcr.io/$PROJECT_ID/search:$SHORT_SHA
      - --platform=managed
      - --region=$_REGION
      - --port=8087
      - --memory=512Mi
      - --cpu=1
      - --min-instances=0
      - --max-instances=10
      - --allow-unauthenticated
      - --set-env-vars=POSTGRES_HOST=$_POSTGRES_HOST,POSTGRES_PORT=5432,POSTGRES_USER=ecommerce,NATS_URL=$_NATS_URL,ELASTICSEARCH_URL=$_ELASTICSEARCH_URL,HTTP_PORT=8087,GRPC_PORT=9087,DB_NAME=ecommerce_search,LOG_LEVEL=info
    waitFor: ['build-search']

  - id: deploy-review
    name: gcr.io/cloud-builders/gcloud
    args:
      - run
      - deploy
      - review-service
      - --image=gcr.io/$PROJECT_ID/review:$SHORT_SHA
      - --platform=managed
      - --region=$_REGION
      - --port=8088
      - --memory=512Mi
      - --cpu=1
      - --min-instances=0
      - --max-instances=10
      - --no-allow-unauthenticated
      - --set-env-vars=POSTGRES_HOST=$_POSTGRES_HOST,POSTGRES_PORT=5432,POSTGRES_USER=ecommerce,NATS_URL=$_NATS_URL,HTTP_PORT=8088,GRPC_PORT=9088,DB_NAME=ecommerce_reviews,LOG_LEVEL=info
    waitFor: ['build-review']

  - id: deploy-media
    name: gcr.io/cloud-builders/gcloud
    args:
      - run
      - deploy
      - media-service
      - --image=gcr.io/$PROJECT_ID/media:$SHORT_SHA
      - --platform=managed
      - --region=$_REGION
      - --port=8089
      - --memory=512Mi
      - --cpu=1
      - --min-instances=0
      - --max-instances=10
      - --no-allow-unauthenticated
      - --set-env-vars=POSTGRES_HOST=$_POSTGRES_HOST,POSTGRES_PORT=5432,POSTGRES_USER=ecommerce,NATS_URL=$_NATS_URL,HTTP_PORT=8089,GRPC_PORT=9089,DB_NAME=ecommerce_media,LOG_LEVEL=info
    waitFor: ['build-media']

  - id: deploy-notification
    name: gcr.io/cloud-builders/gcloud
    args:
      - run
      - deploy
      - notification-service
      - --image=gcr.io/$PROJECT_ID/notification:$SHORT_SHA
      - --platform=managed
      - --region=$_REGION
      - --port=8092
      - --memory=512Mi
      - --cpu=1
      - --min-instances=0
      - --max-instances=10
      - --no-allow-unauthenticated
      - --set-env-vars=POSTGRES_HOST=$_POSTGRES_HOST,POSTGRES_PORT=5432,POSTGRES_USER=ecommerce,NATS_URL=$_NATS_URL,HTTP_PORT=8092,GRPC_PORT=9092,DB_NAME=ecommerce_notifications,LOG_LEVEL=info
    waitFor: ['build-notification']

  - id: deploy-cms
    name: gcr.io/cloud-builders/gcloud
    args:
      - run
      - deploy
      - cms-service
      - --image=gcr.io/$PROJECT_ID/cms:$SHORT_SHA
      - --platform=managed
      - --region=$_REGION
      - --port=8099
      - --memory=512Mi
      - --cpu=1
      - --min-instances=0
      - --max-instances=10
      - --no-allow-unauthenticated
      - --set-env-vars=POSTGRES_HOST=$_POSTGRES_HOST,POSTGRES_PORT=5432,POSTGRES_USER=ecommerce,NATS_URL=$_NATS_URL,HTTP_PORT=8099,GRPC_PORT=9099,DB_NAME=ecommerce_cms,LOG_LEVEL=info
    waitFor: ['build-cms']

  - id: deploy-promotion
    name: gcr.io/cloud-builders/gcloud
    args:
      - run
      - deploy
      - promotion-service
      - --image=gcr.io/$PROJECT_ID/promotion:$SHORT_SHA
      - --platform=managed
      - --region=$_REGION
      - --port=8093
      - --memory=512Mi
      - --cpu=1
      - --min-instances=0
      - --max-instances=10
      - --no-allow-unauthenticated
      - --set-env-vars=POSTGRES_HOST=$_POSTGRES_HOST,POSTGRES_PORT=5432,POSTGRES_USER=ecommerce,NATS_URL=$_NATS_URL,HTTP_PORT=8093,GRPC_PORT=9093,DB_NAME=ecommerce_promotions,LOG_LEVEL=info
    waitFor: ['build-promotion']

  - id: deploy-loyalty
    name: gcr.io/cloud-builders/gcloud
    args:
      - run
      - deploy
      - loyalty-service
      - --image=gcr.io/$PROJECT_ID/loyalty:$SHORT_SHA
      - --platform=managed
      - --region=$_REGION
      - --port=8096
      - --memory=512Mi
      - --cpu=1
      - --min-instances=0
      - --max-instances=10
      - --no-allow-unauthenticated
      - --set-env-vars=POSTGRES_HOST=$_POSTGRES_HOST,POSTGRES_PORT=5432,POSTGRES_USER=ecommerce,NATS_URL=$_NATS_URL,HTTP_PORT=8096,GRPC_PORT=9096,DB_NAME=ecommerce_loyalty,LOG_LEVEL=info
    waitFor: ['build-loyalty']

  - id: deploy-affiliate
    name: gcr.io/cloud-builders/gcloud
    args:
      - run
      - deploy
      - affiliate-service
      - --image=gcr.io/$PROJECT_ID/affiliate:$SHORT_SHA
      - --platform=managed
      - --region=$_REGION
      - --port=8097
      - --memory=512Mi
      - --cpu=1
      - --min-instances=0
      - --max-instances=10
      - --no-allow-unauthenticated
      - --set-env-vars=POSTGRES_HOST=$_POSTGRES_HOST,POSTGRES_PORT=5432,POSTGRES_USER=ecommerce,NATS_URL=$_NATS_URL,HTTP_PORT=8097,GRPC_PORT=9097,DB_NAME=ecommerce_affiliates,LOG_LEVEL=info
    waitFor: ['build-affiliate']

  - id: deploy-chat
    name: gcr.io/cloud-builders/gcloud
    args:
      - run
      - deploy
      - chat-service
      - --image=gcr.io/$PROJECT_ID/chat:$SHORT_SHA
      - --platform=managed
      - --region=$_REGION
      - --port=8094
      - --memory=512Mi
      - --cpu=1
      - --min-instances=0
      - --max-instances=10
      - --no-allow-unauthenticated
      - --set-env-vars=POSTGRES_HOST=$_POSTGRES_HOST,POSTGRES_PORT=5432,POSTGRES_USER=ecommerce,NATS_URL=$_NATS_URL,HTTP_PORT=8094,GRPC_PORT=9094,DB_NAME=ecommerce_chat,LOG_LEVEL=info
    waitFor: ['build-chat']

  - id: deploy-ai
    name: gcr.io/cloud-builders/gcloud
    args:
      - run
      - deploy
      - ai-service
      - --image=gcr.io/$PROJECT_ID/ai:$SHORT_SHA
      - --platform=managed
      - --region=$_REGION
      - --port=8095
      - --memory=1Gi
      - --cpu=2
      - --min-instances=0
      - --max-instances=10
      - --no-allow-unauthenticated
      - --set-env-vars=POSTGRES_HOST=$_POSTGRES_HOST,POSTGRES_PORT=5432,POSTGRES_USER=ecommerce,NATS_URL=$_NATS_URL,HTTP_PORT=8095,GRPC_PORT=9095,DB_NAME=ecommerce_ai,LOG_LEVEL=info
    waitFor: ['build-ai']

# Push all images to GCR
images:
  - gcr.io/$PROJECT_ID/auth:$SHORT_SHA
  - gcr.io/$PROJECT_ID/auth:latest
  - gcr.io/$PROJECT_ID/user:$SHORT_SHA
  - gcr.io/$PROJECT_ID/user:latest
  - gcr.io/$PROJECT_ID/product:$SHORT_SHA
  - gcr.io/$PROJECT_ID/product:latest
  - gcr.io/$PROJECT_ID/cart:$SHORT_SHA
  - gcr.io/$PROJECT_ID/cart:latest
  - gcr.io/$PROJECT_ID/order:$SHORT_SHA
  - gcr.io/$PROJECT_ID/order:latest
  - gcr.io/$PROJECT_ID/payment:$SHORT_SHA
  - gcr.io/$PROJECT_ID/payment:latest
  - gcr.io/$PROJECT_ID/tax:$SHORT_SHA
  - gcr.io/$PROJECT_ID/tax:latest
  - gcr.io/$PROJECT_ID/shipping:$SHORT_SHA
  - gcr.io/$PROJECT_ID/shipping:latest
  - gcr.io/$PROJECT_ID/return:$SHORT_SHA
  - gcr.io/$PROJECT_ID/return:latest
  - gcr.io/$PROJECT_ID/search:$SHORT_SHA
  - gcr.io/$PROJECT_ID/search:latest
  - gcr.io/$PROJECT_ID/review:$SHORT_SHA
  - gcr.io/$PROJECT_ID/review:latest
  - gcr.io/$PROJECT_ID/media:$SHORT_SHA
  - gcr.io/$PROJECT_ID/media:latest
  - gcr.io/$PROJECT_ID/notification:$SHORT_SHA
  - gcr.io/$PROJECT_ID/notification:latest
  - gcr.io/$PROJECT_ID/cms:$SHORT_SHA
  - gcr.io/$PROJECT_ID/cms:latest
  - gcr.io/$PROJECT_ID/promotion:$SHORT_SHA
  - gcr.io/$PROJECT_ID/promotion:latest
  - gcr.io/$PROJECT_ID/loyalty:$SHORT_SHA
  - gcr.io/$PROJECT_ID/loyalty:latest
  - gcr.io/$PROJECT_ID/affiliate:$SHORT_SHA
  - gcr.io/$PROJECT_ID/affiliate:latest
  - gcr.io/$PROJECT_ID/chat:$SHORT_SHA
  - gcr.io/$PROJECT_ID/chat:latest
  - gcr.io/$PROJECT_ID/ai:$SHORT_SHA
  - gcr.io/$PROJECT_ID/ai:latest

timeout: 3600s
